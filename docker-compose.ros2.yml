services:
  discovery-server:
    image: adeept_raspclaws-raspclaws_ros2:latest
    network_mode: host
    container_name: discovery-server
    environment:
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
    command: >
      bash -c "source /opt/ros/humble/setup.bash && 
      fastdds discovery --server-id 0 --ip-address 0.0.0.0 --port 11811 -t 0"
  #      bash -c "source /opt/ros/humble/setup.bash &&
  #      /opt/ros/humble/bin/fast-discovery-server -i 0 -l 0.0.0.0 -p 11811"
    restart: always
    healthcheck:
      test: ["CMD", "netstat", "-tuln", "|", "grep", "11811"]
      interval: 5s
      timeout: 3s
      retries: 3

  raspclaws_ros2:
    image: adeept_raspclaws-raspclaws_ros2:latest
    network_mode: host
    container_name: raspclaws_ros2
    privileged: true  # <--- ERMÃ–GLICHT HARDWARE-ZUGRIFF (I2C)
    devices:
      - "/dev/i2c-1:/dev/i2c-1" # <--- DIREKTE MAP AN DIE SERVOS
    environment:
      - ROS_DISCOVERY_SERVER=127.0.0.1:11811
      - ROS_DOMAIN_ID=0
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp # Erzwingt die richtige Middleware
      - PYTHONPATH=/ros2_ws:/ros2_ws/
    depends_on:
      discovery-server:
        condition: service_healthy  # Warte bis Server wirklich bereit ist
    volumes:
      - /home/pi/adeept_raspclaws:/ros2_ws
      - /dev:/dev  # Gibt dem Container direkten Zugriff auf Kamera und I2C
    command: >
      bash -c "sleep 30 && source /opt/ros/humble/setup.bash && 
      python3 /ros2_ws/Server/ROSServer.py"
    restart: always